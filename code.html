<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SH4LU_Z ENGINE PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Rajdhani:wght@500;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #02040a; color: white; height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Poppins', sans-serif; overflow: hidden; }
        #tech-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .wrapper { display: flex; width: 85%; max-width: 1300px; z-index: 10; justify-content: space-between; align-items: center; }
        .left-content { flex: 1; }
        .hero-text { font-family: 'Russo One', sans-serif; font-size: 5.5rem; line-height: 0.9; text-transform: uppercase; color: #e0e0e0; margin-bottom: 15px; }
        .branding { font-family: 'Rajdhani', sans-serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; border-left: 4px solid #00ff41; padding-left: 15px; color: #aaa; }
        .branding span { color: #00ff41; }
        .right-content { flex: 0 0 420px; }
        .card { background: rgba(10, 15, 20, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 35px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; color: #00ff41; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #00ff41; }
        input { width: 100%; padding: 14px 15px 14px 45px; background: #05080f; border: 1px solid #1f2937; border-radius: 6px; color: #fff; font-family: 'Poppins', sans-serif; outline: none; }
        .action-btn { width: 100%; padding: 14px; background: #00ff41; color: #000; border: none; border-radius: 6px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; font-family: 'Rajdhani', sans-serif; }
        .step { display: none; }
        .step.active { display: block; }
        
        /* üî• FIX: QR Area ‡∂ë‡∂ö ‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä ‡∑Ñ‡∂Ç‡∂ú‡∂Ω‡∑è ‡∂≠‡∑í‡∂∫‡∂±‡∑ä‡∂± */
        #qr-display { background: #000; padding: 10px; border-radius: 8px; border: 2px solid #00ff41; margin: 15px auto; display: none; justify-content: center; width: fit-content; }
        
        #code-display { font-family: 'Rajdhani', sans-serif; font-size: 2rem; color: #00ff41; font-weight: bold; letter-spacing: 4px; text-align: center; border: 1px dashed #00ff41; padding: 10px; margin-top: 10px; background: rgba(0,255,65,0.05); display: none; }
        .method-btn { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 15px; width: 100%; margin-bottom: 10px; border-radius: 6px; color: #ccc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; }
        .method-btn:hover { border-color: #00ff41; color: #fff; background: rgba(0,255,65,0.1); }
        .support-btn { display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%; padding: 12px; margin-top: 20px; background: rgba(0, 255, 65, 0.05); color: #00ff41; border: 1px solid #00ff41; border-radius: 6px; text-decoration: none; font-family: 'Rajdhani', sans-serif; font-weight: 700; }
    </style>
</head>
<body>
    <canvas id="tech-canvas"></canvas>
    <div class="wrapper">
        <div class="left-content">
            <div class="hero-text">CREATE<br>YOUR OWN<br>BOT</div>
            <div class="branding">POWERED BY <span>SH4LU_Z ENGINE</span></div>
        </div>
        <div class="right-content">
            <div class="card">
                <div id="successScreen" class="step">
                    <i class="fa-solid fa-circle-check" style="font-size: 4rem; color: #00ff41; margin-bottom: 15px; display:block; text-align:center;"></i>
                    <h2 style="color: #fff; text-align:center;">CONNECTED!</h2>
                    <p style="color: #888; font-size: 0.9rem; text-align:center;">System is Online & Active.</p>
                    <button class="action-btn" onclick="location.reload()" style="background: #222; color: #fff; margin-top: 20px;">MAIN MENU</button>
                </div>

                <div id="step1" class="step active">
                    <div class="card-header"><i class="fa-solid fa-terminal"></i> INITIALIZE</div>
                    <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="userName" placeholder="Admin Name"></div>
                    <div class="input-group"><i class="fa-solid fa-code"></i><input type="number" id="userAge" placeholder="Age"></div>
                    <button class="action-btn" onclick="next(2)">SYSTEM START >></button>
                </div>

                <div id="step2" class="step">
                    <div class="card-header"><i class="fa-solid fa-sliders"></i> SETTINGS</div>
                    <p style="color:#888; font-size:0.8rem; margin-bottom:15px;">Default config loaded for optimization.</p>
                    <button class="action-btn" onclick="next(3)">CONFIRM CONFIG >></button>
                </div>

                <div id="step3" class="step">
                    <div class="card-header"><i class="fa-solid fa-link"></i> LINK NODE</div>
                    <div class="input-group"><i class="fa-solid fa-robot"></i><input type="text" id="botName" placeholder="Bot Name"></div>
                    <div class="input-group"><i class="fa-brands fa-whatsapp"></i><input type="tel" id="userPhone" placeholder="947xxxxxxxx"></div>
                    <button class="action-btn" onclick="connect()">ESTABLISH CONNECTION</button>
                    <p id="msg" style="display:none; text-align:center; color:#00ff41; margin-top:15px; font-size:0.8rem;"><i class="fa-solid fa-circle-notch fa-spin"></i> Initializing...</p>
                </div>

                <div id="step4" class="step">
                    <div class="card-header"><i class="fa-solid fa-unlock-keyhole"></i> AUTH METHOD</div>
                    <div class="method-btn" onclick="loadMethod('qr')"><i class="fa-solid fa-qrcode"></i> <span>SCAN QR CODE</span></div>
                    <div class="method-btn" onclick="loadMethod('code')"><i class="fa-solid fa-keyboard"></i> <span>PAIRING CODE</span></div>
                </div>

                <div id="step5" class="step">
                    <div class="card-header" id="finalHeader"><i class="fa-solid fa-check"></i> READY</div>
                    <p id="instruction" style="font-size:0.8rem; color:#888; margin-bottom:15px; line-height:1.4;"></p>
                    <div id="loading" style="color:#00ff41; text-align:center; margin:20px 0;"><i class="fa-solid fa-spinner fa-spin"></i> Generating...</div>
                    
                    <div id="qr-display"></div>
                    <div id="code-display"></div>
                    
                    <button class="action-btn" onclick="location.reload()" style="background: #222; color: #fff;">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('tech-canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        class Particle { constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5; this.size = 2; } update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > canvas.width) this.vx *= -1; if (this.y < 0 || this.y > canvas.height) this.vy *= -1; } draw() { ctx.fillStyle = '#00ff41'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        function initParticles() { particles = []; for (let i = 0; i < 70; i++) particles.push(new Particle()); }
        function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animateParticles); }
        initParticles(); animateParticles();

        let phone = ""; let checkInterval = null;
        function next(n) { document.querySelector('.step.active').classList.remove('active'); document.getElementById('step'+n).classList.add('active'); }

        async function connect() {
            phone = document.getElementById('userPhone').value;
            const name = document.getElementById('botName').value;
            const adminName = document.getElementById('userName').value;
            if(!phone || !name) return alert("Fill details!");

            document.querySelector('#step3 .action-btn').style.display = 'none';
            document.getElementById('msg').style.display = 'block';

            try {
                const res = await fetch(`/api/start?id=${phone}&name=${name}&admin_name=${adminName}`);
                if (res.ok) {
                    setTimeout(() => { next(4); }, 1000); // üî• Step 4 (‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏) ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∂∫‡∑í
                    startStatusCheck();
                } else alert("Server Error");
            } catch (e) { alert("Connection Failed"); location.reload(); }
        }

        function loadMethod(type) {
            next(5); // Step 5 ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∂∫‡∑í
            const instruction = document.getElementById('instruction');
            const loader = document.getElementById('loading');
            const qrBox = document.getElementById('qr-display');
            const codeBox = document.getElementById('code-display');

            qrBox.style.display = 'none'; // üî• Reset UI
            codeBox.style.display = 'none';
            loader.style.display = 'block';

            if (type === 'qr') {
                document.getElementById('finalHeader').innerText = "SCAN QR";
                instruction.innerHTML = "Linked Devices > Link a Device > Scan QR";
                
                const interval = setInterval(async () => {
                    const res = await fetch(`/api/qr?id=${phone}`);
                    const data = await res.json();
                    if(data.qr) {
                        loader.style.display = 'none';
                        qrBox.style.display = 'flex'; // üî• Show only QR
                        qrBox.innerHTML = "";
                        new QRCode(qrBox, { text: data.qr, width: 160, height: 160, colorDark : "#00ff41", colorLight : "#000000" });
                        clearInterval(interval);
                    }
                }, 1000);
            } else {
                document.getElementById('finalHeader').innerText = "PAIRING CODE";
                instruction.innerHTML = "Linked Devices > Link with Phone Number";
                
                setTimeout(async () => {
                    try {
                        const res = await fetch(`/api/pair?id=${phone}`);
                        const data = await res.json();
                        loader.style.display = 'none';
                        if(data.code) {
                            codeBox.style.display = 'block'; // üî• Show only Code
                            codeBox.innerText = data.code;
                        } else {
                            alert("Failed to get code. Try QR.");
                            location.reload();
                        }
                    } catch (e) {}
                }, 1000);
            }
        }

        function startStatusCheck() {
            if(checkInterval) clearInterval(checkInterval);
            checkInterval = setInterval(async () => {
                const res = await fetch(`/api/status?id=${phone}`);
                const data = await res.json();
                if(data.status === "connected") {
                    clearInterval(checkInterval);
                    document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
                    document.getElementById('successScreen').classList.add('active');
                }
            }, 2000);
        }
    </script>
</body>
</html>